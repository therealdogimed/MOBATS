module.exports=[40977,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),s=e.i(59756),i=e.i(61916),o=e.i(14444),n=e.i(37092),c=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),h=e.i(66012),y=e.i(70101),g=e.i(26937),m=e.i(10372),f=e.i(93695);e.i(52474);var w=e.i(220),v=e.i(89171),P=e.i(23515);class E{config;isConfigured=!1;constructor(e){this.config=e,this.isConfigured=!!(e.apiKey||e.apiSecret)}async safeVerifyConnection(){let e={errors:[]};for(let t of["live","paper"])try{let r=await this.verifyConnectionMode(t);"live"===t&&(e.live=r),"paper"===t&&(e.paper=r)}catch(r){e.errors?.push(`Error verifying ${t} account: ${r?.message||r}`)}return e}getConfig(){return{...this.config}}isReady(){return this.isConfigured}}class b extends E{baseUrl;dataUrl="https://data.alpaca.markets";constructor(e){super(e),this.baseUrl="live"===e.mode?"https://api.alpaca.markets":"https://paper-api.alpaca.markets"}getHeaders(){return{"APCA-API-KEY-ID":this.config.apiKey,"APCA-API-SECRET-KEY":this.config.apiSecret,"Content-Type":"application/json"}}async request(e,t){let r=await fetch(e,{...t,headers:{...this.getHeaders(),...t?.headers}});if(!r.ok){let e=await r.text();throw Error(`Alpaca API error (${r.status}): ${e}`)}return r.json()}async verifyConnectionMode(e){try{return await this.getAccount(e)}catch(t){throw Error(t instanceof Error?t.message:`Failed to verify ${e} account`)}}async verifyConnection(){try{let e=await this.getAccount();return{success:!0,account:e}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getAccount(e){let t=`${this.baseUrl}/v2/account`+(e?`?mode=${e}`:""),r=await this.request(t),a=parseFloat(r.equity);return{equity:a,buyingPower:parseFloat(r.buying_power),cash:parseFloat(r.cash),status:r.status}}async getPositions(){return(await this.request(`${this.baseUrl}/v2/positions`)).map(e=>({symbol:e.symbol,qty:parseFloat(e.qty),side:"long"===e.side?"long":"short",entryPrice:parseFloat(e.avg_entry_price),currentPrice:parseFloat(e.current_price),unrealizedPL:parseFloat(e.unrealized_pl),unrealizedPLPercent:100*parseFloat(e.unrealized_plpc)}))}async getMarketPrice(e){let t=await this.request(`${this.dataUrl}/v2/stocks/${e}/quotes/latest?feed=iex`);return(t.quote.ap+t.quote.bp)/2}async placeOrder(e){let t=await this.request(`${this.baseUrl}/v2/orders`,{method:"POST",body:JSON.stringify({symbol:e.symbol,qty:e.qty.toString(),side:e.side,type:e.type,time_in_force:e.timeInForce,limit_price:e.limitPrice?.toString(),stop_price:e.stopPrice?.toString()})});return{id:t.id,status:t.status,symbol:t.symbol,qty:parseFloat(t.qty),side:t.side,filledQty:t.filled_qty?parseFloat(t.filled_qty):void 0,avgFillPrice:t.filled_avg_price?parseFloat(t.filled_avg_price):void 0}}async cancelOrder(e){await this.request(`${this.baseUrl}/v2/orders/${e}`,{method:"DELETE"})}async cancelAllOrders(){await this.request(`${this.baseUrl}/v2/orders`,{method:"DELETE"})}async closePosition(e){await this.request(`${this.baseUrl}/v2/positions/${e}`,{method:"DELETE"})}async closeAllPositions(){await this.request(`${this.baseUrl}/v2/positions`,{method:"DELETE"})}async isMarketOpen(){return(await this.request(`${this.baseUrl}/v2/clock`)).is_open}}class A extends E{baseUrl;constructor(e){super(e),this.baseUrl=e.apiEndpoint||"https://localhost:5000"}async request(e,t){let r=await fetch(`${this.baseUrl}${e}`,{...t,headers:{"Content-Type":"application/json",...t?.headers}});if(!r.ok)throw Error(`IBKR API error: ${r.statusText}`);return r.json()}async verifyConnectionMode(e){try{return await this.getAccount(e)}catch(t){throw Error(t instanceof Error?t.message:`Failed to verify ${e} account`)}}async verifyConnection(){try{let e=await this.getAccount();return{success:!0,account:e}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Connection failed"}}}async getAccount(e){let t="/v1/api/portfolio/accounts"+(e?`?mode=${e}`:""),r=await this.request(t),a=parseFloat(r.netliquidation?.amount||"0"),s=parseFloat(r.totalcashvalue?.amount||"0");return{equity:a,buyingPower:parseFloat(r.buyingpower?.amount||"0"),cash:s,status:"active"}}async getPositions(){return(await this.request("/v1/api/portfolio/positions")).map(e=>({symbol:e.contractDesc,qty:e.position,side:e.position>0?"long":"short",entryPrice:e.avgCost,currentPrice:e.mktPrice,unrealizedPL:e.unrealizedPnl,unrealizedPLPercent:e.unrealizedPnl/(e.avgCost*Math.abs(e.position))*100}))}async getMarketPrice(e){let t=await this.request(`/v1/api/md/snapshot?conids=${e}`);return t[0]?.last||0}async placeOrder(e){let t=await this.request("/v1/api/iserver/account/orders",{method:"POST",body:JSON.stringify({conid:e.symbol,orderType:e.type.toUpperCase(),side:e.side.toUpperCase(),quantity:e.qty,price:e.limitPrice,tif:e.timeInForce.toUpperCase()})});return{id:t.order_id,status:t.order_status,symbol:e.symbol,qty:e.qty,side:e.side}}async cancelOrder(e){await this.request(`/v1/api/iserver/account/order/${e}`,{method:"DELETE"})}async cancelAllOrders(){let e=await this.request("/v1/api/iserver/account/orders");await Promise.all(e.map(e=>this.cancelOrder(e.orderId)))}async closePosition(e){let t=(await this.getPositions()).find(t=>t.symbol===e);t&&await this.placeOrder({symbol:e,qty:Math.abs(t.qty),side:"long"===t.side?"sell":"buy",type:"market",timeInForce:"day"})}async closeAllPositions(){let e=await this.getPositions();await Promise.all(e.map(e=>this.closePosition(e.symbol)))}async isMarketOpen(){return!0}}class C extends E{baseUrl="https://api.tdameritrade.com/v1";async verifyConnection(){try{let e=await this.getAccount();return{success:!0,account:e}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Connection failed"}}}async getAccount(){let e=await fetch(`${this.baseUrl}/accounts`,{headers:{Authorization:`Bearer ${this.config.apiKey}`}}),t=(await e.json()).securitiesAccount;return{equity:t.currentBalances.liquidationValue,buyingPower:t.currentBalances.buyingPower,cash:t.currentBalances.cashBalance,status:"active"}}async getPositions(){let e=await fetch(`${this.baseUrl}/accounts?fields=positions`,{headers:{Authorization:`Bearer ${this.config.apiKey}`}});return((await e.json()).securitiesAccount.positions||[]).map(e=>({symbol:e.instrument.symbol,qty:e.longQuantity-e.shortQuantity,side:e.longQuantity>0?"long":"short",entryPrice:e.averagePrice,currentPrice:e.marketValue/(e.longQuantity||e.shortQuantity),unrealizedPL:e.marketValue-e.averagePrice*(e.longQuantity||e.shortQuantity),unrealizedPLPercent:(e.marketValue/(e.averagePrice*(e.longQuantity||e.shortQuantity))-1)*100}))}async getMarketPrice(e){let t=await fetch(`${this.baseUrl}/marketdata/${e}/quotes`,{headers:{Authorization:`Bearer ${this.config.apiKey}`}});return(await t.json())[e].lastPrice}async placeOrder(e){let t=(await fetch(`${this.baseUrl}/accounts/${this.config.additionalConfig?.accountId}/orders`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({orderType:e.type.toUpperCase(),session:"NORMAL",duration:e.timeInForce.toUpperCase(),orderStrategyType:"SINGLE",orderLegCollection:[{instruction:e.side.toUpperCase(),quantity:e.qty,instrument:{symbol:e.symbol,assetType:"EQUITY"}}],price:e.limitPrice})})).headers.get("location");return{id:t?.split("/").pop()||"",status:"ACCEPTED",symbol:e.symbol,qty:e.qty,side:e.side}}async cancelOrder(e){await fetch(`${this.baseUrl}/accounts/${this.config.additionalConfig?.accountId}/orders/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.config.apiKey}`}})}async cancelAllOrders(){let e=await fetch(`${this.baseUrl}/accounts/${this.config.additionalConfig?.accountId}/orders`,{headers:{Authorization:`Bearer ${this.config.apiKey}`}}),t=await e.json();await Promise.all(t.map(e=>this.cancelOrder(e.orderId)))}async closePosition(e){let t=(await this.getPositions()).find(t=>t.symbol===e);t&&await this.placeOrder({symbol:e,qty:Math.abs(t.qty),side:"long"===t.side?"sell":"buy",type:"market",timeInForce:"day"})}async closeAllPositions(){let e=await this.getPositions();await Promise.all(e.map(e=>this.closePosition(e.symbol)))}async isMarketOpen(){let e=await fetch(`${this.baseUrl}/marketdata/hours?markets=EQUITY&date=${new Date().toISOString().split("T")[0]}`,{headers:{Authorization:`Bearer ${this.config.apiKey}`}}),t=await e.json();return t.equity?.EQ?.isOpen||!1}}class R{static createBroker(e){switch(e.type.toLowerCase()){case"alpaca":return new b(e);case"interactive brokers":case"interactivebrokers":case"ibkr":return new A(e);case"td ameritrade":case"tdameritrade":return new C(e);default:throw Error(`Unsupported broker type: ${e.type}`)}}static async createAndVerifyBrokers(e){let t=[];for(let r of e)try{if(!r.apiKey&&!r.apiSecret){console.warn(`Skipping broker ${r.name}: no API credentials`);continue}let e=this.createBroker(r),a=[];if(!r.mode||"live"===r.mode)try{let t=await e.getAccount("live");a.push(t)}catch(e){console.warn(`Live account verification failed for ${r.name}: ${e instanceof Error?e.message:e}`)}if(!r.mode||"paper"===r.mode)try{let t=await e.getAccount("paper");a.push(t)}catch(e){console.warn(`Paper account verification failed for ${r.name}: ${e instanceof Error?e.message:e}`)}a.length>0?t.push({broker:e,accounts:a}):console.warn(`No accounts verified for broker ${r.name}, skipping`)}catch(e){console.error(`Failed to create broker ${r.name}: ${e instanceof Error?e.message:e}`)}return t}static getSupportedBrokers(){return["Alpaca","Interactive Brokers","TD Ameritrade"]}}var $=e.i(49288);async function q(e){let t=(0,$.getErrorHandler)();try{let{action:r,brokerId:a,symbol:s}=await e.json();t.log("critical","EmergencyAPI",`Emergency action: ${r}`,null,{brokerId:a,symbol:s});let i=(0,P.getBotState)(),o=a?i.brokers.find(e=>e.id===a):i.brokers[0];if(!o)return v.NextResponse.json({error:"Broker not found"},{status:404});let n=R.createBroker({id:o.id,name:o.name,type:o.type,apiKey:o.apiKey||"",apiSecret:o.apiSecret||"",mode:o.mode});switch(r){case"cancel_all_orders":await n.cancelAllOrders(),t.log("critical","EmergencyAPI","Cancelled all orders",null,{brokerId:o.id});break;case"close_position":if(!s)return v.NextResponse.json({error:"Symbol required"},{status:400});await n.closePosition(s),t.log("critical","EmergencyAPI",`Closed position: ${s}`,null,{brokerId:o.id});break;case"close_all_positions":await n.closeAllPositions(),t.log("critical","EmergencyAPI","Closed all positions",null,{brokerId:o.id});break;case"emergency_stop":await n.cancelAllOrders(),await n.closeAllPositions(),i.strategies.forEach(e=>e.running=!1),t.log("critical","EmergencyAPI","Emergency stop executed",null,{brokerId:o.id});break;default:return v.NextResponse.json({error:"Invalid action"},{status:400})}return v.NextResponse.json({success:!0,message:`${r} completed successfully`})}catch(e){return t.log("error","EmergencyAPI","Emergency action failed",e),v.NextResponse.json({error:e instanceof Error?e.message:"Emergency action failed"},{status:500})}}e.s(["POST",()=>q],50064);var k=e.i(50064);let O=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/emergency/route",pathname:"/api/emergency",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/emergency/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:U,workUnitAsyncStorage:I,serverHooks:T}=O;function _(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:I})}async function S(e,t,a){O.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/emergency/route";v=v.replace(/\/index$/,"")||"/";let P=await O.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!P)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:b,nextConfig:A,parsedUrl:C,isDraftMode:R,prerenderManifest:$,routerServerContext:q,isOnDemandRevalidate:k,revalidateOnlyGenerated:U,resolvedPathname:I,clientReferenceManifest:T,serverActionsManifest:_}=P,S=(0,c.normalizeAppPath)(v),x=!!($.dynamicRoutes[S]||$.routes[I]),N=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,C,!1):t.end("This page could not be found"),null);if(x&&!R){let e=!!$.routes[I],t=$.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await N();throw new f.NoFallbackError}}let F=null;!x||O.isDev||R||(F="/index"===(F=I)?"/":F);let M=!0===O.isDev||!x,B=x&&!M;_&&T&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:T,serverActionsManifest:_,serverModuleMap:(0,n.createServerModuleMap)({serverActionsManifest:_})});let D=e.method||"GET",j=(0,i.getTracer)(),K=j.getActiveScopeSpan(),L={params:b,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>O.onRequestError(e,t,a,q)},sharedContext:{buildId:E}},H=new l.NodeNextRequest(e),z=new l.NodeNextResponse(t),Q=u.NextRequestAdapter.fromNodeNextRequest(H,(0,u.signalFromNodeResponse)(t));try{let o=async e=>O.handle(Q,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${v}`)}),n=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var i,c;let l=async({previousCacheEntry:r})=>{try{if(!n&&k&&U&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(s);e.fetchMetrics=L.renderOpts.fetchMetrics;let c=L.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let l=L.renderOpts.collectedTags;if(!x)return await (0,h.sendResponse)(H,z,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:k})},q),t}},u=await O.handleResponse({req:e,nextConfig:A,cacheKey:F,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:U,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:n});if(!x)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,y.fromNodeOutgoingHttpHeaders)(u.value.headers);return n&&x||d.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(H,z,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};K?await c(K):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${D} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},c))}catch(t){if(t instanceof f.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:k})}),x)throw t;return await (0,h.sendResponse)(H,z,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>_,"routeModule",()=>O,"serverHooks",()=>T,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>I],40977)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_9d011b8d.js.map