{"version":3,"sources":["../../../lib/alpaca-client.ts"],"sourcesContent":["import type { AlpacaAccount as AlpacaAccountType } from \"./alpaca-client\"\n\ninterface AlpacaPosition {\n  symbol: string\n  qty: string\n  market_value: string\n  unrealized_pl: string\n  unrealized_plpc: string\n}\n\ninterface AlpacaClock {\n  is_open: boolean\n  timestamp: string\n  next_open: string\n  next_close: string\n}\n\ninterface AlpacaQuote {\n  ap: number // ask price\n  bp: number // bid price\n  as: number // ask size\n  bs: number // bid size\n}\n\ninterface AlpacaBar {\n  t: string // timestamp\n  o: number // open\n  h: number // high\n  l: number // low\n  c: number // close\n  v: number // volume\n}\n\ninterface OrderRequest {\n  symbol: string\n  qty: string\n  side: \"buy\" | \"sell\"\n  type: \"market\" | \"limit\" | \"stop\" | \"stop_limit\"\n  time_in_force: \"day\" | \"gtc\" | \"opg\" | \"cls\" | \"ioc\" | \"fok\"\n  limit_price?: string\n  stop_price?: string\n}\n\nexport class AlpacaClient {\n  private baseUrl: string\n  private dataUrl: string\n  private apiKey: string\n  private apiSecret: string\n  private hasCredentials: boolean\n  private mode: \"paper\" | \"live\"\n  private lastVerification: { success: boolean; timestamp: number; account?: any } | null = null\n\n  constructor(apiKey?: string, apiSecret?: string, mode?: \"paper\" | \"live\") {\n    this.apiKey = apiKey || process.env.ALPACA_API_KEY || \"\"\n    this.apiSecret = apiSecret || process.env.ALPACA_API_SECRET || \"\"\n    this.hasCredentials = !!(this.apiKey && this.apiSecret)\n\n    this.mode = mode || (process.env.ALPACA_MODE === \"live\" ? \"live\" : \"paper\")\n\n    this.baseUrl = this.mode === \"paper\" ? \"https://paper-api.alpaca.markets\" : \"https://api.alpaca.markets\"\n    this.dataUrl = \"https://data.alpaca.markets\"\n\n    console.log(\"[v0] Alpaca: Client initialized\", {\n      mode: this.mode.toUpperCase(),\n      baseUrl: this.baseUrl,\n      hasCredentials: this.hasCredentials,\n      credentialSource: apiKey ? \"broker config\" : \"environment variables\",\n    })\n  }\n\n  public isConfigured(): boolean {\n    return this.hasCredentials\n  }\n\n  public getMode(): \"paper\" | \"live\" {\n    return this.mode\n  }\n\n  public async verifyConnection(): Promise<{ success: boolean; account?: any; error?: string }> {\n    if (!this.hasCredentials) {\n      return { success: false, error: \"No credentials configured\" }\n    }\n\n    try {\n      console.log(\"[v0] Alpaca: Verifying connection...\", { mode: this.mode })\n\n      const account = await this.getAccount()\n\n      console.log(\"[v0] Alpaca: Connection verified successfully\", {\n        accountNumber: account.account_number,\n        status: account.status,\n        mode: this.mode,\n        equity: account.equity,\n        buyingPower: account.buying_power,\n        tradingBlocked: account.trading_blocked,\n        patternDayTrader: account.pattern_day_trader,\n      })\n\n      this.lastVerification = {\n        success: true,\n        timestamp: Date.now(),\n        account,\n      }\n\n      return { success: true, account }\n    } catch (error) {\n      const errorMsg = error instanceof Error ? error.message : String(error)\n      console.error(\"[v0] Alpaca: Connection verification failed\", {\n        mode: this.mode,\n        error: errorMsg,\n      })\n\n      this.lastVerification = {\n        success: false,\n        timestamp: Date.now(),\n      }\n\n      return { success: false, error: errorMsg }\n    }\n  }\n\n  public getLastVerification() {\n    return this.lastVerification\n  }\n\n  private getHeaders(): HeadersInit {\n    console.log(\"[v0] Alpaca: Request headers\", {\n      hasKeyId: !!this.apiKey,\n      hasSecret: !!this.apiSecret,\n      keyIdPrefix: this.apiKey?.substring(0, 8) + \"...\",\n    })\n\n    return {\n      \"APCA-API-KEY-ID\": this.apiKey,\n      \"APCA-API-SECRET-KEY\": this.apiSecret,\n      \"Content-Type\": \"application/json\",\n    }\n  }\n\n  private async request<T>(url: string, options?: RequestInit): Promise<T> {\n    if (!this.hasCredentials) {\n      throw new Error(\"Alpaca API credentials not configured\")\n    }\n\n    try {\n      const response = await fetch(url, {\n        ...options,\n        headers: {\n          ...this.getHeaders(),\n          ...options?.headers,\n        },\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        console.error(\"[v0] Alpaca: API error\", {\n          status: response.status,\n          statusText: response.statusText,\n          error: errorText,\n          url,\n        })\n        throw new Error(`Alpaca API error (${response.status}): ${errorText}`)\n      }\n\n      const data = await response.json()\n      return data\n    } catch (error) {\n      console.error(\"[v0] Alpaca: Request failed\", { url, error })\n      throw error\n    }\n  }\n\n  async getAccount(): Promise<AlpacaAccountType> {\n    const account = await this.request<AlpacaAccountType>(`${this.baseUrl}/v2/account`)\n    return account\n  }\n\n  async getPositions(): Promise<AlpacaPosition[]> {\n    return this.request<AlpacaPosition[]>(`${this.baseUrl}/v2/positions`)\n  }\n\n  async getClock(): Promise<AlpacaClock> {\n    const clock = await this.request<AlpacaClock>(`${this.baseUrl}/v2/clock`)\n    return clock\n  }\n\n  async getQuote(symbol: string): Promise<AlpacaQuote> {\n    return this.request<AlpacaQuote>(`${this.dataUrl}/v2/stocks/${symbol}/quotes/latest`)\n  }\n\n  async getLatestBars(symbols: string[]): Promise<Record<string, AlpacaBar>> {\n    const symbolsStr = symbols.join(\",\")\n    const url = `${this.dataUrl}/v2/stocks/bars/latest?symbols=${symbolsStr}&feed=iex`\n\n    const data = await this.request<{ bars: Record<string, AlpacaBar> }>(url)\n    return data.bars\n  }\n\n  async getLatestQuote(symbol: string): Promise<AlpacaQuote> {\n    const url = `${this.dataUrl}/v2/stocks/${symbol}/quotes/latest?feed=iex`\n    const data = await this.request<{ quote: AlpacaQuote }>(url)\n    return data.quote\n  }\n\n  async createOrder(order: OrderRequest): Promise<any> {\n    console.log(\"[v0] Alpaca: Preparing to place order\", {\n      symbol: order.symbol,\n      qty: order.qty,\n      side: order.side,\n      type: order.type,\n      time_in_force: order.time_in_force,\n      mode: this.mode,\n      baseUrl: this.baseUrl,\n    })\n\n    if (!this.hasCredentials) {\n      throw new Error(\"Alpaca API credentials not configured\")\n    }\n\n    try {\n      const clock = await this.getClock()\n      const now = new Date()\n\n      if (!clock.is_open) {\n        const nextOpen = new Date(clock.next_open)\n        const hoursUntilOpen = ((nextOpen.getTime() - now.getTime()) / (1000 * 60 * 60)).toFixed(1)\n\n        console.warn(\"[v0] Alpaca: ⚠️ MARKET IS CLOSED - Order will be queued\", {\n          currentTime: now.toISOString(),\n          nextOpen: clock.next_open,\n          hoursUntilOpen,\n          message: \"This order will NOT execute until market opens at 9:30 AM ET\",\n        })\n\n        // Return warning but allow order to be queued\n      } else {\n        console.log(\"[v0] Alpaca: ✅ Market is OPEN - Order will execute immediately\")\n      }\n    } catch (error) {\n      console.warn(\"[v0] Alpaca: Could not check market hours\", error)\n    }\n\n    try {\n      const account = await this.getAccount()\n      console.log(\"[v0] Alpaca: Account status before order\", {\n        accountNumber: account.account_number,\n        equity: account.equity,\n        buyingPower: account.buying_power,\n        cash: account.cash,\n        tradingBlocked: account.trading_blocked,\n        status: account.status,\n      })\n\n      if (account.trading_blocked) {\n        throw new Error(\"❌ Trading is blocked on this account\")\n      }\n\n      const buyingPower = Number.parseFloat(account.buying_power)\n      if (buyingPower <= 0) {\n        throw new Error(`❌ Insufficient buying power: $${buyingPower}`)\n      }\n    } catch (error) {\n      console.error(\"[v0] Alpaca: Account check failed before order\", error)\n      throw error\n    }\n\n    try {\n      const result = await this.request(`${this.baseUrl}/v2/orders`, {\n        method: \"POST\",\n        body: JSON.stringify(order),\n      })\n\n      console.log(\"[v0] Alpaca: ✅ Order placed successfully\", {\n        orderId: result.id,\n        status: result.status,\n        symbol: result.symbol,\n        qty: result.qty,\n        side: result.side,\n        submittedAt: result.submitted_at,\n        mode: this.mode,\n      })\n      return result\n    } catch (error) {\n      console.error(\"[v0] Alpaca: ❌ Order placement failed\", {\n        order,\n        mode: this.mode,\n        error: error instanceof Error ? error.message : String(error),\n      })\n      throw error\n    }\n  }\n\n  async cancelAllOrders(): Promise<any> {\n    return this.request(`${this.baseUrl}/v2/orders`, {\n      method: \"DELETE\",\n    })\n  }\n\n  async closeAllPositions(): Promise<any> {\n    return this.request(`${this.baseUrl}/v2/positions`, {\n      method: \"DELETE\",\n    })\n  }\n\n  async isMarketOpen(): Promise<boolean> {\n    try {\n      const clock = await this.getClock()\n      return clock.is_open\n    } catch (error) {\n      console.error(\"[v0] Alpaca: Failed to check market hours\", error)\n      return false\n    }\n  }\n\n  async getHistoricalBars(symbol: string, timeframe: string, start: string, end: string): Promise<AlpacaBar[]> {\n    const url = `${this.dataUrl}/v2/stocks/${symbol}/bars?timeframe=${timeframe}&start=${start}&end=${end}&feed=iex`\n    const data = await this.request<{ bars: AlpacaBar[] }>(url)\n    return data.bars || []\n  }\n\n  async getRealtimeQuotes(symbols: string[]): Promise<Record<string, AlpacaQuote>> {\n    const quotes: Record<string, AlpacaQuote> = {}\n    for (const symbol of symbols) {\n      try {\n        quotes[symbol] = await this.getLatestQuote(symbol)\n      } catch (error) {\n        console.warn(`[v0] Alpaca: Failed to get quote for ${symbol}`, error)\n      }\n    }\n    return quotes\n  }\n}\n\nexport function createAlpacaClient(apiKey?: string, apiSecret?: string, mode?: \"paper\" | \"live\"): AlpacaClient {\n  return new AlpacaClient(apiKey, apiSecret, mode)\n}\n\nexport function getAlpacaClient(): AlpacaClient {\n  return new AlpacaClient()\n}\n"],"names":[],"mappings":"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"}